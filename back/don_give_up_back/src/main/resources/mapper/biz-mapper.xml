<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="kr.or.iei.biz.model.dao.BizDao">


<!-- 전체 기부사업 게시글 수 조회 --> 
<select id="selectBoardCount" resultType="_int" parameterType="map">
    SELECT count(*)
    FROM tbl_donate_biz
    WHERE biz_status = 1
    <if test="categories != null and categories.size() > 0">
        AND donate_code IN
        <foreach collection="categories" item="code" open="(" separator="," close=")">
            #{code}
        </foreach>
    </if>
</select>

<!-- 기부 사업 리스트 조회 -->
<select id="selectDonateBizList" parameterType="map" resultType="Biz">
    SELECT biz_no AS bizNo,
           org_no AS orgNo,
           org_name AS orgName,
           donate_code AS donateCode,
           biz_name AS bizName,
           biz_content AS bizContent,
           biz_donate_start AS bizDonateStart,
           biz_donate_end AS bizDonateEnd,
           biz_start AS bizStart,
           biz_end AS bizEnd,
           biz_goal AS bizGoal,
           biz_status AS bizStatus,
           biz_reg_date AS bizRegDate,
           biz_edit AS bizEdit,
           biz_thumb AS bizThumbPath
    FROM (
        SELECT rownum rnum, a.*
        FROM (
            SELECT b.biz_no,
                   b.org_no,
                   o.org_name,
                   b.donate_code,
                   b.biz_name,
                   b.biz_content,
                   b.biz_donate_start,
                   b.biz_donate_end,
                   b.biz_start,
                   b.biz_end,
                   b.biz_goal,
                   b.biz_status,
                   b.biz_reg_date,
                   b.biz_edit,
                   b.biz_thumb
            FROM tbl_donate_biz b
            JOIN tbl_org o ON b.org_no = o.org_no
            WHERE b.biz_status = 1
            <if test="categories != null and categories.size() > 0">
                AND b.donate_code IN
                <foreach collection="categories" item="code" open="(" separator="," close=")">
                    #{code}
                </foreach>
            </if>
            ORDER BY b.biz_reg_date DESC
        ) a
    )
    WHERE rnum BETWEEN #{start} AND #{end}
</select>

<!-- 한 개의 기부 게시글 정보 조회 -->
<select id="selectOneDonateBiz" parameterType="_int" resultType="Biz">
	select b.biz_no as bizNo,
           b.org_no as orgNo,
           o.org_name as orgName,
           b.donate_code as donateCode,
           b.biz_name as bizName,
           b.biz_content as bizContent,
           b.biz_donate_start as bizDonateStart,
           b.biz_donate_end as bizDonateEnd,
           b.biz_start as bizStart,
           b.biz_end as bizEnd,
           b.biz_goal as bizGoal,
           b.biz_status as bizStatus,
           b.biz_reg_date as bizRegDate,
           b.biz_edit as bizEdit,
           b.biz_thumb as bizThumbPath
		from tbl_donate_biz b
		JOIN tbl_org o ON b.org_no = o.org_no
		where biz_no = #{_parameter}
</select>

<!-- 검색 게시물 개수 조회 -->
<select id="selectSearchCount" parameterType="Keyword" resultType="_int">
	SELECT COUNT(*)
	FROM tbl_donate_biz b
	JOIN tbl_org o ON b.org_no = o.org_no
	WHERE b.biz_status = 1
	<choose>
		<when test="bizTitle != null and bizTitle != ''">
			AND b.biz_name LIKE '%' || #{bizTitle} || '%'
		</when>
		<when test="orgName != null and orgName != ''">
			AND o.org_name LIKE '%' || #{orgName} || '%'
		</when>
	</choose>
</select>


<!-- 검색 게시물 리스트 조회 -->
<select id="selectSearchBizList" parameterType="Keyword" resultType="Biz">
SELECT *
FROM (
    SELECT rownum rnum, a.*
    FROM (
        SELECT b.biz_no AS bizNo,
               b.org_no AS orgNo,
               o.org_name AS orgName,
               b.donate_code AS donateCode,
               b.biz_name AS bizName,
               b.biz_content AS bizContent,
               b.biz_donate_start AS bizDonateStart,
               b.biz_donate_end AS bizDonateEnd,
               b.biz_start AS bizStart,
               b.biz_end AS bizEnd,
               b.biz_goal AS bizGoal,
               b.biz_status AS bizStatus,
               b.biz_reg_date AS bizRegDate,
               b.biz_edit AS bizEdit,
               b.biz_thumb AS bizThumbPath
        FROM tbl_donate_biz b
        JOIN tbl_org o ON b.org_no = o.org_no
        WHERE b.biz_status = 1
        <if test="bizTitle != null and bizTitle != ''">
            AND b.biz_name LIKE '%' || #{bizTitle} || '%'
        </if>
        <if test="(bizTitle == null or bizTitle == '') and orgName != null and orgName != ''">
            AND o.org_name LIKE '%' || #{orgName} || '%'
        </if>
        ORDER BY b.biz_reg_date DESC
    ) a
    WHERE rownum &lt;= #{pageInfo.end}
)
WHERE rnum &gt;= #{pageInfo.start}
</select>

</mapper>
